<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSBE Battle Pass - Comprehensive Test Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }
        .test-section {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #475569;
            border-radius: 8px;
            margin: 16px 0;
            padding: 20px;
        }
        .test-result {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 4px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .test-pass { background: #065f46; border: 1px solid #10b981; }
        .test-fail { background: #7f1d1d; border: 1px solid #ef4444; }
        .test-info { background: #1e3a8a; border: 1px solid #3b82f6; }
        .test-warn { background: #92400e; border: 1px solid #f59e0b; }
        .loading { color: #fbbf24; }
        .code-block {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 4px;
            padding: 12px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 16px 0;
        }
        .stat-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid #475569;
            border-radius: 6px;
            padding: 16px;
            text-align: center;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #60a5fa;
        }
        .stat-label {
            color: #94a3b8;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-300 mb-2">üß™ NSBE Battle Pass Test Suite</h1>
            <p class="text-gray-400">Comprehensive testing of all system components</p>
        </div>

        <!-- Quick Actions -->
        <div class="test-section">
            <h2 class="text-2xl font-bold text-yellow-300 mb-4">üöÄ Quick Actions</h2>
            <div class="flex flex-wrap gap-4">
                <button onclick="runAllTests()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white">
                    Run All Tests
                </button>
                <button onclick="testDataIntegration()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white">
                    Test Data Integration
                </button>
                <button onclick="testBadgeSystem()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-white">
                    Test Badge System
                </button>
                <button onclick="testLeaderboard()" class="bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded text-white">
                    Test Leaderboard
                </button>
                <button onclick="clearResults()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded text-white">
                    Clear Results
                </button>
            </div>
        </div>

        <!-- System Status -->
        <div class="test-section">
            <h2 class="text-2xl font-bold text-green-300 mb-4">üìä System Status</h2>
            <div id="system-status" class="stat-grid">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Test Results -->
        <div class="test-section">
            <h2 class="text-2xl font-bold text-blue-300 mb-4">üìù Test Results</h2>
            <div id="test-results">
                <div class="test-info">Ready to run tests. Click "Run All Tests" to begin.</div>
            </div>
        </div>

        <!-- Data Inspection -->
        <div class="test-section">
            <h2 class="text-2xl font-bold text-purple-300 mb-4">üîç Data Inspection</h2>
            <div id="data-inspection">
                <div class="test-info">Data inspection results will appear here.</div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="test-section">
            <h2 class="text-2xl font-bold text-red-300 mb-4">‚ö° Performance Metrics</h2>
            <div id="performance-metrics">
                <div class="test-info">Performance metrics will be collected during tests.</div>
            </div>
        </div>
    </div>

    <!-- Load Dependencies -->
    <script type="text/babel" src="./src/Data-Constants.js"></script>
    <script type="text/babel" src="./src/Shared-style.js"></script>
    <script type="text/babel" src="./src/helpers.js"></script>
    <script type="text/babel" src="./src/LocalDataManager.js"></script>

    <script>
        // Test Suite Implementation
        let testResults = [];
        let performanceMetrics = {};

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const resultDiv = document.getElementById('test-results');
            const logEntry = document.createElement('div');
            logEntry.className = `test-result test-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            resultDiv.appendChild(logEntry);
            resultDiv.scrollTop = resultDiv.scrollHeight;
            
            // Store result
            testResults.push({ timestamp, message, type });
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '<div class="test-info">Results cleared. Ready for new tests.</div>';
            document.getElementById('data-inspection').innerHTML = '<div class="test-info">Data inspection results will appear here.</div>';
            document.getElementById('performance-metrics').innerHTML = '<div class="test-info">Performance metrics will be collected during tests.</div>';
            testResults = [];
            performanceMetrics = {};
        }

        function updateSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            const csvLoaded = window.CSV_OVERRIDE_DATA ? window.CSV_OVERRIDE_DATA.length : 0;
            const badgesConfigured = window.TRACKABLE_BADGES_CONFIG ? window.TRACKABLE_BADGES_CONFIG.length : 0;
            const sheetsConfigured = window.SHEETS_CONFIG ? Object.keys(window.SHEETS_CONFIG).length : 0;

            statusDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${csvLoaded}</div>
                    <div class="stat-label">CSV Records</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${badgesConfigured}</div>
                    <div class="stat-label">Badge Types</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${sheetsConfigured}</div>
                    <div class="stat-label">Sheets Configured</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${testResults.length}</div>
                    <div class="stat-label">Tests Run</div>
                </div>
            `;
        }

        async function testSystemComponents() {
            log("üîß Testing System Components...", "info");
            
            // Test 1: Data Constants
            try {
                if (window.TRACKABLE_BADGES_CONFIG) {
                    log(`‚úÖ Badge configuration loaded: ${window.TRACKABLE_BADGES_CONFIG.length} badges`, "pass");
                } else {
                    log("‚ùå Badge configuration not found", "fail");
                }
            } catch (error) {
                log(`‚ùå Badge configuration error: ${error.message}`, "fail");
            }

            // Test 2: Shared Styles
            try {
                if (window.SHARED_STYLES && window.SHARED_STYLES.clipPaths) {
                    log("‚úÖ Shared styles loaded successfully", "pass");
                } else {
                    log("‚ùå Shared styles not properly loaded", "fail");
                }
            } catch (error) {
                log(`‚ùå Shared styles error: ${error.message}`, "fail");
            }

            // Test 3: Helper Functions
            try {
                if (typeof window.formatEventDate === 'function') {
                    const testDate = window.formatEventDate('2024-09-29');
                    log(`‚úÖ Helper functions loaded: formatEventDate works (${testDate})`, "pass");
                } else {
                    log("‚ùå Helper functions not found", "fail");
                }
            } catch (error) {
                log(`‚ùå Helper functions error: ${error.message}`, "fail");
            }

            // Test 4: LocalDataManager
            try {
                if (typeof window.fetchSignInData === 'function') {
                    log("‚úÖ LocalDataManager functions available", "pass");
                } else {
                    log("‚ùå LocalDataManager functions not found", "fail");
                }
            } catch (error) {
                log(`‚ùå LocalDataManager error: ${error.message}`, "fail");
            }
        }

        async function testDataIntegration() {
            log("üìä Testing Data Integration...", "info");
            const startTime = performance.now();

            try {
                // Test CSV Data Loading
                log("Loading CSV data...", "info");
                if (window.CSV_OVERRIDE_DATA) {
                    log(`‚úÖ CSV data already loaded: ${window.CSV_OVERRIDE_DATA.length} records`, "pass");
                } else {
                    log("‚è≥ Waiting for CSV data to load...", "loading");
                    await new Promise(resolve => {
                        const checkData = () => {
                            if (window.CSV_OVERRIDE_DATA) {
                                log(`‚úÖ CSV data loaded: ${window.CSV_OVERRIDE_DATA.length} records`, "pass");
                                resolve();
                            } else {
                                setTimeout(checkData, 100);
                            }
                        };
                        checkData();
                    });
                }

                // Test Live Sheet Data
                log("Testing live sheet integration...", "info");
                try {
                    const liveData = await window.getLiveSheetData();
                    if (liveData && liveData.length > 0) {
                        log(`‚úÖ Live sheet data loaded: ${liveData.length} records`, "pass");
                    } else {
                        log("‚ö†Ô∏è Live sheet data empty or not available", "warn");
                    }
                } catch (error) {
                    log(`‚ö†Ô∏è Live sheet access failed: ${error.message}`, "warn");
                }

                // Test Combined Data
                log("Testing combined data integration...", "info");
                const combinedData = await window.fetchSignInData();
                if (combinedData && combinedData.length > 0) {
                    log(`‚úÖ Combined data integration successful: ${combinedData.length} total records`, "pass");
                    
                    // Analyze data composition
                    const csvCount = window.CSV_OVERRIDE_DATA ? window.CSV_OVERRIDE_DATA.length : 0;
                    const liveCount = combinedData.length - csvCount;
                    log(`üìà Data composition: ${csvCount} CSV + ${liveCount} live = ${combinedData.length} total`, "info");
                } else {
                    log("‚ùå Combined data integration failed", "fail");
                }

                const endTime = performance.now();
                performanceMetrics.dataIntegration = endTime - startTime;
                log(`‚ö° Data integration completed in ${(endTime - startTime).toFixed(2)}ms`, "info");

            } catch (error) {
                log(`‚ùå Data integration test failed: ${error.message}`, "fail");
            }
        }

        async function testBadgeSystem() {
            log("üèÜ Testing Badge System...", "info");
            const startTime = performance.now();

            try {
                // Test Badge Configuration
                if (!window.TRACKABLE_BADGES_CONFIG) {
                    log("‚ùå Badge configuration not available", "fail");
                    return;
                }

                log(`‚úÖ Badge configuration available: ${window.TRACKABLE_BADGES_CONFIG.length} badge types`, "pass");

                // Test getMemberStats function
                if (typeof window.getMemberStats !== 'function') {
                    log("‚ùå getMemberStats function not available", "fail");
                    return;
                }

                // Test with a sample member (you can change this to a real member identifier)
                const testMember = "testuser"; // Change to real uniqname for testing
                log(`Testing badge calculation for member: ${testMember}`, "info");
                
                const memberStats = await window.getMemberStats(testMember);
                if (memberStats) {
                    log(`‚úÖ Badge calculation successful for ${memberStats.member}`, "pass");
                    log(`üìä Member stats: ${memberStats.total_events} events, ${memberStats.total_points} points`, "info");
                    
                    // Test each badge type
                    window.TRACKABLE_BADGES_CONFIG.forEach(badge => {
                        const eventCount = memberStats[badge.requirement.type] || 0;
                        const progress = Math.min(eventCount / badge.requirement.count, 1);
                        const earned = progress >= 1;
                        log(`${earned ? 'üèÜ' : '‚è≥'} ${badge.name}: ${eventCount}/${badge.requirement.count} (${(progress * 100).toFixed(1)}%)`, 
                            earned ? "pass" : "info");
                    });
                } else {
                    log(`‚ö†Ô∏è No data found for member: ${testMember}`, "warn");
                }

                const endTime = performance.now();
                performanceMetrics.badgeSystem = endTime - startTime;
                log(`‚ö° Badge system test completed in ${(endTime - startTime).toFixed(2)}ms`, "info");

            } catch (error) {
                log(`‚ùå Badge system test failed: ${error.message}`, "fail");
            }
        }

        async function testLeaderboard() {
            log("üèÖ Testing Leaderboard System...", "info");
            const startTime = performance.now();

            try {
                // Test leaderboard generation
                if (typeof window.getLocalLeaderboard !== 'function') {
                    log("‚ùå getLocalLeaderboard function not available", "fail");
                    return;
                }

                log("Generating leaderboard...", "info");
                const leaderboard = await window.getLocalLeaderboard();
                
                if (leaderboard && leaderboard.length > 0) {
                    log(`‚úÖ Leaderboard generated: ${leaderboard.length} members`, "pass");
                    
                    // Show top 5 members
                    log("üèÜ Top 5 Members:", "info");
                    leaderboard.slice(0, 5).forEach((member, index) => {
                        log(`${index + 1}. ${member.displayName} - ${member.totalPoints} points (${member.tier})`, "info");
                    });

                    // Test tier distribution
                    const tierCounts = {};
                    leaderboard.forEach(member => {
                        tierCounts[member.tier] = (tierCounts[member.tier] || 0) + 1;
                    });
                    
                    log("üìä Tier Distribution:", "info");
                    Object.entries(tierCounts).forEach(([tier, count]) => {
                        log(`  ${tier}: ${count} members`, "info");
                    });

                } else {
                    log("‚ùå Leaderboard generation failed or empty", "fail");
                }

                const endTime = performance.now();
                performanceMetrics.leaderboard = endTime - startTime;
                log(`‚ö° Leaderboard test completed in ${(endTime - startTime).toFixed(2)}ms`, "info");

            } catch (error) {
                log(`‚ùå Leaderboard test failed: ${error.message}`, "fail");
            }
        }

        async function testPerformance() {
            log("‚ö° Running Performance Tests...", "info");

            // Test data loading performance
            const dataLoadStart = performance.now();
            await window.fetchSignInData();
            const dataLoadEnd = performance.now();
            performanceMetrics.dataLoad = dataLoadEnd - dataLoadStart;

            // Test leaderboard generation performance
            const leaderboardStart = performance.now();
            await window.getLocalLeaderboard();
            const leaderboardEnd = performance.now();
            performanceMetrics.leaderboardGeneration = leaderboardEnd - leaderboardStart;

            // Display performance metrics
            const metricsDiv = document.getElementById('performance-metrics');
            metricsDiv.innerHTML = `
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-value">${performanceMetrics.dataLoad?.toFixed(2) || 'N/A'}ms</div>
                        <div class="stat-label">Data Load Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${performanceMetrics.leaderboardGeneration?.toFixed(2) || 'N/A'}ms</div>
                        <div class="stat-label">Leaderboard Generation</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${performanceMetrics.badgeSystem?.toFixed(2) || 'N/A'}ms</div>
                        <div class="stat-label">Badge Calculation</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${performanceMetrics.dataIntegration?.toFixed(2) || 'N/A'}ms</div>
                        <div class="stat-label">Data Integration</div>
                    </div>
                </div>
            `;

            log(`üìä Performance test completed`, "pass");
        }

        async function inspectData() {
            log("üîç Inspecting Data...", "info");

            try {
                const inspectionDiv = document.getElementById('data-inspection');
                let inspectionHTML = '';

                // CSV Data Inspection
                if (window.CSV_OVERRIDE_DATA) {
                    const csvSample = window.CSV_OVERRIDE_DATA[0];
                    inspectionHTML += `
                        <h3 class="text-lg font-bold text-blue-300 mb-2">CSV Data Sample</h3>
                        <div class="code-block">
                            <pre>${JSON.stringify(csvSample, null, 2)}</pre>
                        </div>
                    `;
                }

                // Live Data Inspection
                try {
                    const liveData = await window.getLiveSheetData();
                    if (liveData && liveData.length > 0) {
                        const liveSample = liveData[0];
                        inspectionHTML += `
                            <h3 class="text-lg font-bold text-green-300 mb-2">Live Sheet Data Sample</h3>
                            <div class="code-block">
                                <pre>${JSON.stringify(liveSample, null, 2)}</pre>
                            </div>
                        `;
                    }
                } catch (error) {
                    inspectionHTML += `
                        <h3 class="text-lg font-bold text-red-300 mb-2">Live Sheet Data</h3>
                        <div class="test-warn">Unable to fetch live data: ${error.message}</div>
                    `;
                }

                // Badge Configuration Inspection
                if (window.TRACKABLE_BADGES_CONFIG) {
                    inspectionHTML += `
                        <h3 class="text-lg font-bold text-purple-300 mb-2">Badge Configuration</h3>
                        <div class="code-block">
                            <pre>${JSON.stringify(window.TRACKABLE_BADGES_CONFIG.slice(0, 2), null, 2)}</pre>
                        </div>
                    `;
                }

                inspectionDiv.innerHTML = inspectionHTML;
                log("‚úÖ Data inspection completed", "pass");

            } catch (error) {
                log(`‚ùå Data inspection failed: ${error.message}`, "fail");
            }
        }

        async function runAllTests() {
            log("üöÄ Starting Comprehensive Test Suite...", "info");
            clearResults();
            
            await testSystemComponents();
            await testDataIntegration();
            await testBadgeSystem();
            await testLeaderboard();
            await testPerformance();
            await inspectData();
            
            updateSystemStatus();
            
            const passCount = testResults.filter(r => r.type === 'pass').length;
            const failCount = testResults.filter(r => r.type === 'fail').length;
            const warnCount = testResults.filter(r => r.type === 'warn').length;
            
            log(`üéâ Test Suite Complete! Results: ${passCount} passed, ${failCount} failed, ${warnCount} warnings`, 
                failCount > 0 ? "warn" : "pass");
        }

        // Initialize status on page load
        window.addEventListener('load', () => {
            setTimeout(updateSystemStatus, 1000);
        });
    </script>
</body>
</html>